import re
from typing import List, Set
import emoji

# === СПИСКИ СТАНЦИЙ МЕТРО ===
STATIONS = [
    'сокольники',
    'красносельская',
    'комсомольская',
    'красные ворота',
    'чистые пруды',
    'лубянка',
    'охотный ряд',
    'библиотека им. ленина',
    'кропоткинская',
    'парк культуры',
    'фрунзенская',
    'спортивная',
    'воробьёвы горы',
    'университет',
    'проспект вернадского',
    'юго-западная',
    'тропарёво',
    'алма-атинская',
    'красногвардейская',
    'домодедовская',
    'орехово',
    'царицыно',
    'кантемировская',
    'каширская',
    'коломенская',
    'автозаводская',
    'павелецкая',
    'новокузнецкая',
    'театральная',
    'тверская',
    'маяковская',
    'белорусская',
    'динамо',
    'аэропорт',
    'сокол',
    'войковская',
    'водный стадион',
    'речной вокзал',
    'пятницкое шоссе',
    'митино',
    'волоколамская',
    'мякинино',
    'строгино',
    'крылатское',
    'молодежная',
    'кунцевская',
    'славянский бульвар',
    'парк победы',
    'киевская',
    'смоленская',
    'арбатская',
    'площадь революции',
    'курская',
    'бауманская',
    'электрозаводская',
    'семеновская',
    'партизанская',
    'измайловская',
    'первомайская',
    'щелковская',
    'александровский сад',
    'выставочная',
    'международная',
    'студенческая',
    'кутузовская',
    'фили',
    'багратионовская',
    'филевский парк',
    'пионерская',
    'новослободская',
    'проспект мира',
    'таганская',
    'добрынинская',
    'октябрьская',
    'краснопресненская',
    'медведково',
    'бабушкинская',
    'свиблово',
    'ботанический сад',
    'вднх',
    'алексеевская',
    'рижская',
    'сухаревская',
    'тургеневская',
    'китай-город',
    'третьяковская',
    'шаболовская',
    'ленинский проспект',
    'академическая',
    'профсоюзная',
    'новые черемушки',
    'калужская',
    'беляево',
    'коньково',
    'теплый стан',
    'ясенево',
    'новоясеневская',
    'жулебино',
    'лермонтовский проспект',
    'выхино',
    'рязанский проспект',
    'кузьминки',
    'текстильщики',
    'волгоградский проспект',
    'пролетарская',
    'кузнецкий мост',
    'пушкинская',
    'баррикадная',
    'улица 1905 года',
    'беговая',
    'полежаевская',
    'октябрьское поле',
    'щукинская',
    'спартак',
    'тушинская',
    'сходненская',
    'планерная',
    'новокосино',
    'новогиреево',
    'перово',
    'шоссе энтузиастов',
    'авиамоторная',
    'площадь ильича',
    'марксистская',
    'деловой центр',
    'алтуфьево',
    'бибирево',
    'отрадное',
    'владыкино',
    'петровско-разумовская',
    'тимирязевская',
    'дмитровская',
    'савеловская',
    'менделеевская',
    'цветной бульвар',
    'чеховская',
    'боровицкая',
    'полянка',
    'серпуховская',
    'тульская',
    'нагатинская',
    'нагорная',
    'нахимовский проспект',
    'севастопольская',
    'чертановская',
    'южная',
    'пражская',
    'улица академика янгеля',
    'аннино',
    'бульвар дмитрия донского',
    'марьина роща',
    'достоевская',
    'трубная',
    'сретенский бульвар',
    'чкаловская',
    'римская',
    'крестьянская застава',
    'дубровка',
    'кожуховская',
    'печатники',
    'волжская',
    'люблино',
    'братиславская',
    'марьино',
    'борисово',
    'шипиловская',
    'зябликово',
    'варшавская',
    'каховская',
    'битцевский парк',
    'лесопарковая',
    'улица старо-качаловская',
    'улица скобелевская',
    'бульвар адмирала ушакова',
    'улица горчакова',
    'бунинская аллея',
    'лухмановская',
    'улица дмитриевского',
    'косино',
    'юго-восточная',
    'окская',
    'стахановская',
    'нижегородская',
    'коммунарка',
    'корниловская',
    'тютчевская',
    'генерала тюленева',
    'университет дружбы народов',
    'новаторская',
    'вавиловская',
    'крымская',
    'зил',
    'метро'
]

# === СТОП-СЛОВА ===
RUSSIAN_STOPWORDS = {
    'и', 'в', 'во', 'не', 'что', 'он', 'на', 'я', 'с', 'со', 'как', 'а', 'то', 'все', 'она',
    'так', 'его', 'но', 'да', 'ты', 'к', 'у', 'же', 'вы', 'за', 'бы', 'по', 'только', 'ее',
    'мне', 'было', 'вот', 'от', 'меня', 'еще', 'нет', 'о', 'из', 'ему', 'теперь', 'когда',
    'даже', 'ну', 'вдруг', 'ли', 'если', 'уже', 'или', 'ни', 'быть', 'был', 'него', 'до',
    'вас', 'нибудь', 'опять', 'уж', 'вам', 'ведь', 'там', 'потом', 'себя', 'ничего',
    'ей', 'может', 'они', 'тут', 'где', 'есть', 'надо', 'ней', 'для', 'мы', 'тебя', 'их',
    'чем', 'была', 'сам', 'чтоб', 'без', 'будто', 'чего', 'раз', 'тоже', 'себе', 'под',
    'будет', 'ж', 'тогда', 'кто', 'этот', 'того', 'потому', 'этого', 'какой', 'совсем',
    'ним', 'здесь', 'этом', 'один', 'почти', 'мой', 'тем', 'чтобы', 'нее', 'сейчас',
    'были', 'куда', 'зачем', 'всех', 'никогда', 'можно', 'при', 'наконец', 'два',
    'об', 'другой', 'хоть', 'после', 'над', 'больше', 'тот', 'через', 'эти', 'нас',
    'про', 'всего', 'них', 'какая', 'много', 'разве', 'три', 'эту', 'моя', 'впрочем',
    'хорошо', 'свою', 'этой', 'перед', 'иногда', 'лучше', 'чуть', 'том', 'нельзя',
    'такой', 'им', 'более', 'всегда', 'конечно', 'всю', 'между'
}

METRO_STOPWORDS = {
    'метро', 'станция', 'пассажир', 'москва', 'московский',
    'подземка', 'время', 'город', 'работа', 'транспорт',
    'это', 'который', 'также', 'год', 'день', 'новый', 'vk',
    'движение', 'маршрут', 'путь', 'центр', 'работать', 'поездка', 'подслушать'
}

ALL_STOPWORDS = RUSSIAN_STOPWORDS.union(METRO_STOPWORDS)


def remove_emojis(text: str) -> str:
    """
    Удаляет эмодзи из текста.
    Использует библиотеку emoji, а если её нет - регулярное выражение.
    """
    if not isinstance(text, str):
        return ""
    
    try:
        # Используем библиотеку emoji если установлена
        return emoji.replace_emoji(text, replace='')
    except (ImportError, AttributeError):
        # Резервный вариант: регулярное выражение для удаления эмодзи
        emoji_pattern = re.compile(
            "["
            u"\U0001F600-\U0001F64F"  # emoticons
            u"\U0001F300-\U0001F5FF"  # symbols & pictographs
            u"\U0001F680-\U0001F6FF"  # transport & map symbols
            u"\U0001F1E0-\U0001F1FF"  # flags (iOS)
            u"\U00002702-\U000027B0"
            u"\U000024C2-\U0001F251"
            "]+", flags=re.UNICODE
        )
        return emoji_pattern.sub('', text)


def contains_station(text: str) -> bool:
    """
    Проверяет, содержит ли текст упоминание станции метро.
    Оптимизированная версия с предварительной подготовкой текста.
    """
    if not text:
        return False
    
    # Проверяем наличие хотя бы одной станции в тексте
    for station in STATIONS:
        if station in text:
            return True
    return False


def preprocess_text(text: str) -> str:
    """
    Основной пайплайн препроцессинга текста.
    
    Этапы обработки:
    1. Проверка входных данных
    2. Удаление эмодзи
    3. Приведение к нижнему регистру
    4. Проверка наличия станций метро
    5. Очистка от спецсимволов и цифр
    6. Проверка длины текста
    7. Удаление стоп-слов
    
    Возвращает обработанный текст или пустую строку если текст не проходит фильтры.
    """
    # 1. Проверка входных данных
    if not isinstance(text, str) or not text.strip():
        return ""
    
    # 2. Удаление эмодзи
    text = remove_emojis(text)
    
    # 3. Приведение к нижнему регистру
    text = text.lower().strip()
    
    # 4. Проверка на наличие станции метро
    if not contains_station(text):
        return ""
    
    # 5. Очистка от спецсимволов, цифр и лишних пробелов
    text = re.sub(r'[^а-яё\s]', ' ', text)  # удаляем всё кроме букв и пробелов
    text = re.sub(r'\s+', ' ', text).strip()  # нормализуем пробелы
    
    # 6. Проверка длины текста в словах
    words = text.split()
    if len(words) < 3 or len(words) > 150:
        return ""
    
    # 7. Удаление стоп-слов и коротких слов
    filtered_words = []
    for word in words:
        # Пропускаем стоп-слова и очень короткие слова (менее 2 символов)
        if word not in ALL_STOPWORDS and len(word) > 2:
            filtered_words.append(word)
    
    # Если после фильтрации осталось мало слов
    if len(filtered_words) < 2:
        return ""
    
    return " ".join(filtered_words)


def find_stations_in_text(text: str) -> List[str]:
    """
    Находит все упоминания станций метро в тексте.
    
    Возвращает список найденных станций.
    """
    found = []
    if not isinstance(text, str):
        return found
    
    text_lower = text.lower()
    for station in STATIONS:
        if station in text_lower:
            found.append(station)
    
    return found


def get_station_count() -> int:
    """Возвращает количество станций метро в списке."""
    return len(STATIONS)


def get_stopwords_count() -> int:
    """Возвращает общее количество стоп-слов."""
    return len(ALL_STOPWORDS)


def get_stations() -> List[str]:
    """Возвращает копию списка станций метро."""
    return STATIONS.copy()


def get_stopwords() -> Set[str]:
    """Возвращает копию множества стоп-слов."""
    return ALL_STOPWORDS.copy()


# Экспортируемые функции
__all__ = [
    'preprocess_text',
    'remove_emojis',
    'find_stations_in_text',
    'get_station_count',
    'get_stopwords_count',
    'get_stations',
    'get_stopwords',
    'STATIONS',
    'ALL_STOPWORDS'
]